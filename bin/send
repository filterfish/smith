#!/usr/bin/env ruby

$:.unshift(File.dirname(__FILE__) + '/../lib')

require 'pp'
require 'smith'

queue_name = ARGV[0]
if queue_name.nil?
  puts "usage: #{$0} <queue> <message>"
  exit
end

message = ARGV[1] || ""

l = (Regexp.new(/^lambda/).match(message)) ? eval(message) : lambda { message }

EM.run do
  queue = RubyMAS::Messaging.new(queue_name)
  queue.send_message(l.call)
  AMQP.stop { EM.stop }
end
