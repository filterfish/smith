#!/usr/bin/env ruby

$:.unshift(File.dirname(__FILE__) + '/../lib')

require 'smith'
require 'smith/application/agency'
require 'daemons/daemonize'

include Daemonize

opts = Trollop::options do
  opt :agents_dir,   "directory containing the agents", :type => :string, :required => true
  opt :logging,      "logging config file", :type => :string, :required => true
  opt :daemon,       "daemonise", :default => false
  opt :amqp_logging, "turn amqp logging on", :default => false
  opt :fdsize,       "max number of file descriptors", :type => :integer, :default => 1024
end

agents_to_start = ARGV

if ! agents_to_start.empty?
  puts "Starting Agents:\n%s" % agents_to_start.inject("") {|str,a| str << "  #{a}\n" }
end

opts[:logging] = File.expand_path(opts[:logging])
opts[:agents_dir] = File.expand_path(opts[:agents_dir])

daemonize('/tmp/log') if opts[:daemon]

EM.epoll
EM.set_descriptor_table_size(opts[:fdsize])

EM.run do
  AMQP.logging = true if opts[:amqp_logging]

  agency = Agency.new(opts)

  agency.setup_signal_handlers
  agency.setup_queue_handlers

  n = 0
  start_agent = proc {
    if n < agents_to_start.size
      RubyMAS::Messaging.new(:manage).send_message(agents_to_start[n])
      n += 1
      EM.next_tick(&start_agent)
    end
  }

  EM.next_tick(&start_agent)
end
